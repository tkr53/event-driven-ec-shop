<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EC Shop - Event Driven Demo</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f5f5f5; }

        header { background: #333; color: white; padding: 1rem 2rem; display: flex; justify-content: space-between; align-items: center; }
        header h1 { font-size: 1.5rem; }
        .cart-icon { background: #ff6b6b; padding: 0.5rem 1rem; border-radius: 20px; cursor: pointer; }
        .cart-icon:hover { background: #ee5a5a; }

        .container { max-width: 1200px; margin: 0 auto; padding: 2rem; }

        .tabs { display: flex; gap: 1rem; margin-bottom: 2rem; }
        .tab { padding: 0.75rem 1.5rem; background: white; border: none; border-radius: 8px; cursor: pointer; font-size: 1rem; }
        .tab.active { background: #333; color: white; }
        .tab:hover:not(.active) { background: #eee; }

        .panel { display: none; }
        .panel.active { display: block; }

        /* Products */
        .products-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 1.5rem; }
        .product-card { background: white; border-radius: 12px; padding: 1.5rem; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .product-card h3 { margin-bottom: 0.5rem; color: #333; }
        .product-card .description { color: #666; font-size: 0.9rem; margin-bottom: 1rem; }
        .product-card .price { font-size: 1.5rem; font-weight: bold; color: #ff6b6b; }
        .product-card .stock { font-size: 0.85rem; color: #888; margin-top: 0.5rem; }
        .product-card button { width: 100%; margin-top: 1rem; padding: 0.75rem; background: #333; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 1rem; }
        .product-card button:hover { background: #555; }
        .product-card button:disabled { background: #ccc; cursor: not-allowed; }

        /* Cart */
        .cart-items { background: white; border-radius: 12px; padding: 1.5rem; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .cart-item { display: flex; justify-content: space-between; align-items: center; padding: 1rem 0; border-bottom: 1px solid #eee; }
        .cart-item:last-child { border-bottom: none; }
        .cart-item .info h4 { margin-bottom: 0.25rem; }
        .cart-item .info span { color: #666; font-size: 0.9rem; }
        .cart-item .actions { display: flex; align-items: center; gap: 1rem; }
        .cart-item .remove { background: #ff6b6b; color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; }
        .cart-total { margin-top: 1.5rem; padding-top: 1.5rem; border-top: 2px solid #333; display: flex; justify-content: space-between; align-items: center; }
        .cart-total .total { font-size: 1.5rem; font-weight: bold; }
        .checkout-btn { background: #ff6b6b; color: white; border: none; padding: 1rem 2rem; border-radius: 8px; font-size: 1.1rem; cursor: pointer; }
        .checkout-btn:hover { background: #ee5a5a; }
        .checkout-btn:disabled { background: #ccc; cursor: not-allowed; }
        .empty-cart { text-align: center; padding: 3rem; color: #888; }

        /* Orders */
        .order-card { background: white; border-radius: 12px; padding: 1.5rem; margin-bottom: 1rem; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .order-header { display: flex; justify-content: space-between; margin-bottom: 1rem; padding-bottom: 1rem; border-bottom: 1px solid #eee; }
        .order-id { font-family: monospace; color: #666; }
        .order-status { padding: 0.25rem 0.75rem; border-radius: 12px; font-size: 0.85rem; }
        .order-status.pending { background: #fff3cd; color: #856404; }
        .order-status.paid { background: #d4edda; color: #155724; }
        .order-status.shipped { background: #cce5ff; color: #004085; }
        .order-status.cancelled { background: #f8d7da; color: #721c24; }
        .order-items { margin-bottom: 1rem; }
        .order-item { display: flex; justify-content: space-between; padding: 0.5rem 0; }
        .order-total { font-weight: bold; text-align: right; padding-top: 1rem; border-top: 1px solid #eee; }
        .cancel-btn { background: #dc3545; color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; margin-top: 1rem; }
        .cancel-btn:hover { background: #c82333; }
        .empty-orders { text-align: center; padding: 3rem; color: #888; }

        /* Admin */
        .admin-form { background: white; border-radius: 12px; padding: 1.5rem; box-shadow: 0 2px 8px rgba(0,0,0,0.1); max-width: 500px; }
        .admin-form h3 { margin-bottom: 1rem; }
        .form-group { margin-bottom: 1rem; }
        .form-group label { display: block; margin-bottom: 0.5rem; font-weight: 500; }
        .form-group input { width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 6px; font-size: 1rem; }
        .admin-form button { width: 100%; padding: 0.75rem; background: #28a745; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 1rem; }
        .admin-form button:hover { background: #218838; }

        /* Toast */
        .toast { position: fixed; bottom: 2rem; right: 2rem; background: #333; color: white; padding: 1rem 1.5rem; border-radius: 8px; opacity: 0; transition: opacity 0.3s; }
        .toast.show { opacity: 1; }
        .toast.success { background: #28a745; }
        .toast.error { background: #dc3545; }

        /* Loading */
        .loading { text-align: center; padding: 2rem; color: #888; }
    </style>
</head>
<body>
    <header>
        <h1>EC Shop</h1>
        <div class="cart-icon" onclick="showTab('cart')">
            Cart (<span id="cart-count">0</span>)
        </div>
    </header>

    <div class="container">
        <div class="tabs">
            <button class="tab active" onclick="showTab('products')">Products</button>
            <button class="tab" onclick="showTab('cart')">Cart</button>
            <button class="tab" onclick="showTab('orders')">Orders</button>
            <button class="tab" onclick="showTab('admin')">Admin</button>
        </div>

        <!-- Products Panel -->
        <div id="products-panel" class="panel active">
            <div id="products-grid" class="products-grid">
                <div class="loading">Loading products...</div>
            </div>
        </div>

        <!-- Cart Panel -->
        <div id="cart-panel" class="panel">
            <div id="cart-content" class="cart-items">
                <div class="empty-cart">Your cart is empty</div>
            </div>
        </div>

        <!-- Orders Panel -->
        <div id="orders-panel" class="panel">
            <div id="orders-content">
                <div class="loading">Loading orders...</div>
            </div>
        </div>

        <!-- Admin Panel -->
        <div id="admin-panel" class="panel">
            <div class="admin-form">
                <h3>Add New Product</h3>
                <div class="form-group">
                    <label>Product Name</label>
                    <input type="text" id="product-name" placeholder="e.g. T-Shirt">
                </div>
                <div class="form-group">
                    <label>Description</label>
                    <input type="text" id="product-desc" placeholder="e.g. 100% Cotton">
                </div>
                <div class="form-group">
                    <label>Price (JPY)</label>
                    <input type="number" id="product-price" placeholder="e.g. 2000">
                </div>
                <div class="form-group">
                    <label>Stock</label>
                    <input type="number" id="product-stock" placeholder="e.g. 100">
                </div>
                <button onclick="addProduct()">Add Product</button>
            </div>
        </div>
    </div>

    <div id="toast" class="toast"></div>

    <script>
        const API = '';

        // Show tab
        function showTab(tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
            document.querySelector(`[onclick="showTab('${tab}')"]`).classList.add('active');
            document.getElementById(`${tab}-panel`).classList.add('active');

            if (tab === 'products') loadProducts();
            if (tab === 'cart') loadCart();
            if (tab === 'orders') loadOrders();
        }

        // Toast notification
        function showToast(message, type = '') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = 'toast show ' + type;
            setTimeout(() => toast.className = 'toast', 3000);
        }

        // Load products
        async function loadProducts() {
            try {
                const res = await fetch(`${API}/products`);
                const products = await res.json();
                const grid = document.getElementById('products-grid');

                if (!products || products.length === 0) {
                    grid.innerHTML = '<div class="empty-cart">No products available. Add some from Admin tab!</div>';
                    return;
                }

                grid.innerHTML = products.map(p => `
                    <div class="product-card">
                        <h3>${escapeHtml(p.name)}</h3>
                        <p class="description">${escapeHtml(p.description)}</p>
                        <div class="price">¥${p.price.toLocaleString()}</div>
                        <div class="stock">Stock: ${p.stock}</div>
                        <button onclick="addToCart('${p.id}')" ${p.stock <= 0 ? 'disabled' : ''}>
                            ${p.stock <= 0 ? 'Out of Stock' : 'Add to Cart'}
                        </button>
                    </div>
                `).join('');
            } catch (e) {
                console.error(e);
                showToast('Failed to load products', 'error');
            }
        }

        // Load cart
        async function loadCart() {
            try {
                const res = await fetch(`${API}/cart`);
                const cart = await res.json();
                const content = document.getElementById('cart-content');
                document.getElementById('cart-count').textContent = cart.items?.length || 0;

                if (!cart.items || cart.items.length === 0) {
                    content.innerHTML = '<div class="empty-cart">Your cart is empty</div>';
                    return;
                }

                content.innerHTML = `
                    ${cart.items.map(item => `
                        <div class="cart-item">
                            <div class="info">
                                <h4>${escapeHtml(item.name || item.product_id)}</h4>
                                <span>¥${item.price.toLocaleString()} × ${item.quantity}</span>
                            </div>
                            <div class="actions">
                                <strong>¥${(item.price * item.quantity).toLocaleString()}</strong>
                                <button class="remove" onclick="removeFromCart('${item.product_id}')">Remove</button>
                            </div>
                        </div>
                    `).join('')}
                    <div class="cart-total">
                        <span>Total</span>
                        <span class="total">¥${cart.total.toLocaleString()}</span>
                    </div>
                    <button class="checkout-btn" onclick="placeOrder()" style="width:100%;margin-top:1rem;">
                        Place Order
                    </button>
                `;
            } catch (e) {
                console.error(e);
                showToast('Failed to load cart', 'error');
            }
        }

        // Load orders
        async function loadOrders() {
            try {
                const res = await fetch(`${API}/orders`);
                const orders = await res.json();
                const content = document.getElementById('orders-content');

                if (!orders || orders.length === 0) {
                    content.innerHTML = '<div class="empty-orders">No orders yet</div>';
                    return;
                }

                content.innerHTML = orders.map(o => `
                    <div class="order-card">
                        <div class="order-header">
                            <span class="order-id">Order: ${o.id.substring(0, 8)}...</span>
                            <span class="order-status ${o.status}">${o.status}</span>
                        </div>
                        <div class="order-items">
                            ${o.items.map(item => `
                                <div class="order-item">
                                    <span>${item.product_id.substring(0, 8)}... × ${item.quantity}</span>
                                    <span>¥${(item.price * item.quantity).toLocaleString()}</span>
                                </div>
                            `).join('')}
                        </div>
                        <div class="order-total">Total: ¥${o.total.toLocaleString()}</div>
                        ${o.status === 'pending' ? `<button class="cancel-btn" onclick="cancelOrder('${o.id}')">Cancel Order</button>` : ''}
                    </div>
                `).join('');
            } catch (e) {
                console.error(e);
                showToast('Failed to load orders', 'error');
            }
        }

        // Add to cart
        async function addToCart(productId) {
            try {
                await fetch(`${API}/cart/items`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ product_id: productId, quantity: 1 })
                });
                showToast('Added to cart!', 'success');
                loadCart();
            } catch (e) {
                showToast('Failed to add to cart', 'error');
            }
        }

        // Remove from cart
        async function removeFromCart(productId) {
            try {
                await fetch(`${API}/cart/items/${productId}`, { method: 'DELETE' });
                showToast('Removed from cart', 'success');
                loadCart();
            } catch (e) {
                showToast('Failed to remove item', 'error');
            }
        }

        // Place order
        async function placeOrder() {
            try {
                const res = await fetch(`${API}/orders`, { method: 'POST' });
                if (!res.ok) throw new Error('Order failed');
                showToast('Order placed!', 'success');
                loadCart();
                loadProducts();
                showTab('orders');
            } catch (e) {
                showToast('Failed to place order', 'error');
            }
        }

        // Cancel order
        async function cancelOrder(orderId) {
            try {
                await fetch(`${API}/orders/${orderId}/cancel`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ reason: 'User cancelled' })
                });
                showToast('Order cancelled', 'success');
                loadOrders();
                loadProducts();
            } catch (e) {
                showToast('Failed to cancel order', 'error');
            }
        }

        // Add product (admin)
        async function addProduct() {
            const name = document.getElementById('product-name').value;
            const description = document.getElementById('product-desc').value;
            const price = parseInt(document.getElementById('product-price').value);
            const stock = parseInt(document.getElementById('product-stock').value);

            if (!name || !price || !stock) {
                showToast('Please fill all fields', 'error');
                return;
            }

            try {
                await fetch(`${API}/products`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, description, price, stock })
                });
                showToast('Product added!', 'success');
                document.getElementById('product-name').value = '';
                document.getElementById('product-desc').value = '';
                document.getElementById('product-price').value = '';
                document.getElementById('product-stock').value = '';
                loadProducts();
            } catch (e) {
                showToast('Failed to add product', 'error');
            }
        }

        // Escape HTML
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text || '';
            return div.innerHTML;
        }

        // Initial load
        loadProducts();
        loadCart();
    </script>
</body>
</html>
